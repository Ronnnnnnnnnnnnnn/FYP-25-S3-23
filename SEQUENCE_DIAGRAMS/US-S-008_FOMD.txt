# FOMD SEQUENCE DIAGRAM FOR SEQUENCEDIAGRAM.ORG
# Copy everything below the line and paste into https://sequencediagram.org

# ==================================================================================
# COPY FROM HERE ↓
# ==================================================================================

title FOMD Animation Generation\nUser Story: US-S-008 - As a subscriber, I want to use the FOMD feature

participant Subscriber
participant Browser
participant Frontend
participant API
participant HuggingFaceAPI
participant FaceDetector
participant FOMMModel
participant Storage
participant Database

note over Subscriber, Database: Upload Source Image

Subscriber->Browser: 1. Select image file
Browser->Frontend: 2. Display image preview
Frontend->Frontend: 3. Validate file\n(type, size, format)

alt Invalid image
    Frontend-->Subscriber: Error: Invalid image format
end

note over Subscriber, Database: Upload Driving Video

Subscriber->Browser: 4. Select video file
Browser->Frontend: 5. Display video preview
Frontend->Frontend: 6. Validate file\n(type, size, format)

alt Invalid video
    Frontend-->Subscriber: Error: Invalid video format
end

note over Subscriber, Database: Submit for Processing

Subscriber->Frontend: 7. Click "Generate Animation"
Frontend->Frontend: 8. Show progress (0%)
Frontend->API: 9. POST /api/fomd/animate\n(image, video files)

note over API: API Validation & File Storage

API->API: 10. Validate request
API->API: 11. Check user role\n(subscriber/admin required)
API->Storage: 12. Save uploaded files temporarily
Storage-->API: 13. Return file paths

note over API, FaceDetector: Face Detection - Source Image

API->HuggingFaceAPI: 14. Call FOMD API\n(https://Tc12345-fomd.hf.space)
HuggingFaceAPI->FaceDetector: 15. Detect face in image
FaceDetector-->HuggingFaceAPI: 16. Return face coordinates

alt No face in image
    HuggingFaceAPI-->API: Error: No face detected in image
    API-->Frontend: Error message
    Frontend-->Subscriber: No face found!\nPlease use clear portrait
end

API->Frontend: 17. Progress: 20%\n"Detecting faces..."
Frontend->Subscriber: Update progress bar: 20%

note over API, FaceDetector: Face Detection - Driving Video

HuggingFaceAPI->FaceDetector: 18. Detect face in video frames
FaceDetector-->HuggingFaceAPI: 19. Return face keypoints per frame

alt No face in video
    HuggingFaceAPI-->API: Error: No face in video
    API-->Frontend: Error message
    Frontend-->Subscriber: No face found in video!
end

API->Frontend: 20. Progress: 40%\n"Extracting keypoints..."
Frontend->Subscriber: Update progress bar: 40%

note over API, FOMMModel: Model Processing - Load Source

HuggingFaceAPI->FOMMModel: 21. Load source image (256x256)
FOMMModel->FOMMModel: 22. Extract source keypoints
FOMMModel-->HuggingFaceAPI: 23. Source keypoints extracted

note over API, FOMMModel: Model Processing - Load Driving Video

HuggingFaceAPI->FOMMModel: 24. Load driving video frames
FOMMModel->FOMMModel: 25. Extract driving keypoints per frame
FOMMModel-->HuggingFaceAPI: 26. Driving keypoints extracted

API->Frontend: 27. Progress: 60%\n"Generating animation..."
Frontend->Subscriber: Update progress bar: 60%

note over FOMMModel: VoxCeleb Model\nGenerating Animation\n60-120s (CPU) | 15-30s (GPU)

HuggingFaceAPI->FOMMModel: 28. Generate animation frames
FOMMModel->FOMMModel: 29. Dense motion generation
FOMMModel->FOMMModel: 30. Frame synthesis
FOMMModel->FOMMModel: 31. Apply motion to source image

API->Frontend: 32. Progress: 80%\n"Finalizing video..."
Frontend->Subscriber: Update progress bar: 80%

FOMMModel-->HuggingFaceAPI: 33. Animated frames (256x256, 30fps)
HuggingFaceAPI->HuggingFaceAPI: 34. Combine frames into MP4 video
HuggingFaceAPI-->API: 35. Video URL

note over API, Storage: Save Result

API->API: 36. Download video from HuggingFace
API->Storage: 37. Save MP4 video\nstatic/animations/fomd/filename.mp4
Storage-->API: 38. Video saved

API->Database: 39. INSERT INTO animations\n(user_id, tool_type='fomd', animation_path, status='completed')
Database-->API: 40. Animation ID

API->Frontend: 41. Progress: 100%\n"Complete!"
Frontend->Subscriber: Update progress bar: 100%

note over API, Subscriber: Display Result

API-->Frontend: 42. Response:\nvideo_url, status: success
Frontend->Frontend: 43. Load video player
Frontend->Subscriber: 44. Auto-play animated video

note over Subscriber, Storage: Save to Dashboard (Optional)

Subscriber->Frontend: 45. Click "Save to Dashboard"
Frontend->Frontend: 46. Convert video to base64
Frontend->API: 47. POST /api/fomd/save\n(video_data: base64)

API->API: 48. Decode base64 video
API->Storage: 49. Save video\nstatic/animations/fomd/filename.mp4
Storage-->API: 50. File saved

API->Database: 51. INSERT INTO animations\n(user_id, tool_type='fomd', animation_path, status='completed')
Database-->API: 52. Animation ID

API->Frontend: 53. Response: success=true\nvideo_url
Frontend->Subscriber: 54. Success message\n"FOMD animation saved!"

note over Subscriber, Storage: Download Video (Optional)

Subscriber->Frontend: 55. Click "Download Video"
Frontend->Storage: 56. Fetch video file
Storage-->Frontend: 57. MP4 file
Frontend-->Subscriber: 58. Download:\nanimated_TIMESTAMP.mp4

# ==================================================================================
# COPY UNTIL HERE ↑
# ==================================================================================


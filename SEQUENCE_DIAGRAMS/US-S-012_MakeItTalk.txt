# MAKEITTALK SEQUENCE DIAGRAM FOR SEQUENCEDIAGRAM.ORG
# Copy everything below the line and paste into https://sequencediagram.org

# ==================================================================================
# COPY FROM HERE ↓
# ==================================================================================

title MakeItTalk - Talking Portrait Generation\nUser Story: US-S-012 - As a subscriber, I want to use the MakeItTalk feature

participant Subscriber
participant Browser
participant Frontend
participant GradioClient
participant HuggingFaceAPI
participant FaceDetector
participant AudioProcessor
participant MakeItTalkModel
participant API
participant Storage
participant Database

note over Subscriber, Database: Upload Portrait Image

Subscriber->Browser: 1. Select portrait image
Browser->Frontend: 2. Display image preview
Frontend->Frontend: 3. Validate image\n(JPG/PNG, <50MB)

alt Invalid image
    Frontend-->Subscriber: Error: Invalid image
end

note over Subscriber, Database: Upload Audio File

Subscriber->Browser: 4. Select audio file
Browser->Frontend: 5. Display audio player
Frontend->Frontend: 6. Validate audio\n(WAV/MP3, <20MB)

alt Invalid audio
    Frontend-->Subscriber: Error: Invalid or too long
end

note over Subscriber, Database: Submit to API

Subscriber->Frontend: 7. Click "Generate Talking Portrait"
Frontend->Frontend: 8. Show progress (0%)
Frontend->GradioClient: 9. Connect to Gradio API\n(Tc12345/MakeItTalk)

GradioClient->HuggingFaceAPI: 10. Initialize connection
HuggingFaceAPI-->GradioClient: 11. Connection established

Frontend->Frontend: 12. Progress: 10%\n"Uploading files..."
Subscriber->Subscriber: Update progress: 10%

GradioClient->HuggingFaceAPI: 13. Upload image and audio files
HuggingFaceAPI->HuggingFaceAPI: 14. Files received

note over HuggingFaceAPI, FaceDetector: Detect Facial Landmarks

Frontend->Frontend: 15. Progress: 20%\n"Detecting facial landmarks..."
Subscriber->Subscriber: Update progress: 20%

HuggingFaceAPI->FaceDetector: 16. Detect 68 facial landmarks
FaceDetector->FaceDetector: 17. Extract face region
FaceDetector-->HuggingFaceAPI: 18. Landmark coordinates

alt No face detected
    HuggingFaceAPI-->GradioClient: Error: No face detected
    GradioClient-->Frontend: Error message
    Frontend-->Subscriber: No face found!\nUse front-facing portrait
end

note over HuggingFaceAPI, AudioProcessor: Process Audio

Frontend->Frontend: 19. Progress: 30%\n"Processing audio..."
Subscriber->Subscriber: Update progress: 30%

HuggingFaceAPI->AudioProcessor: 20. Load audio (16kHz)
AudioProcessor->AudioProcessor: 21. Extract audio features
AudioProcessor->AudioProcessor: 22. Extract mel-spectrogram
AudioProcessor-->HuggingFaceAPI: 23. Audio feature vectors

note over HuggingFaceAPI, MakeItTalkModel: Generate Lip Movements

Frontend->Frontend: 24. Progress: 50%\n"Generating lip movements..."
Subscriber->Subscriber: Update progress: 50%

HuggingFaceAPI->MakeItTalkModel: 25. Generate lip sync
MakeItTalkModel->MakeItTalkModel: 26. Audio-visual alignment
MakeItTalkModel->MakeItTalkModel: 27. Map audio features to lip movements
MakeItTalkModel-->HuggingFaceAPI: 28. Lip movement coordinates

note over HuggingFaceAPI, MakeItTalkModel: Create Animation Frames

Frontend->Frontend: 29. Progress: 70%\n"Creating animation frames..."
Subscriber->Subscriber: Update progress: 70%

HuggingFaceAPI->MakeItTalkModel: 30. Animate face with lip sync
MakeItTalkModel->MakeItTalkModel: 31. Apply facial expressions
MakeItTalkModel->MakeItTalkModel: 32. Generate frames (256x256)
MakeItTalkModel->MakeItTalkModel: 33. Warp face mesh based on landmarks

note over MakeItTalkModel: Processing Time\n2-5 minutes (CPU)\n30-90 seconds (GPU)

MakeItTalkModel-->HuggingFaceAPI: 34. Animation frames

note over HuggingFaceAPI, Storage: Combine Audio + Video

Frontend->Frontend: 35. Progress: 90%\n"Combining audio and video..."
Subscriber->Subscriber: Update progress: 90%

HuggingFaceAPI->HuggingFaceAPI: 36. Combine frames + audio
HuggingFaceAPI->HuggingFaceAPI: 37. Encode MP4 video
HuggingFaceAPI-->GradioClient: 38. Video URL

GradioClient->Frontend: 39. Video URL received

Frontend->Frontend: 40. Progress: 100%\n"Complete!"
Subscriber->Subscriber: Update progress: 100%

note over HuggingFaceAPI, Subscriber: Display Result

Frontend->Frontend: 41. Load video player
Frontend->Subscriber: 42. Auto-play talking portrait

note over Subscriber, Storage: Save to Dashboard (Optional)

Subscriber->Frontend: 43. Click "Save to Dashboard"
Frontend->Frontend: 44. Fetch video from URL
Frontend->Frontend: 45. Convert video to base64
Frontend->API: 46. POST /api/makeittalk/save\n(video_data: base64)

API->API: 47. Decode base64 video
API->Storage: 48. Save MP4 video\nstatic/animations/makeittalk/filename.mp4
Storage-->API: 49. File saved

API->Database: 50. INSERT INTO animations\n(user_id, tool_type='makeittalk', animation_path, status='completed')
Database-->API: 51. Animation ID

API->Frontend: 52. Response: success=true\nvideo_url
Frontend->Subscriber: 53. Success message\n"MakeItTalk animation saved!"

note over Subscriber, Storage: Download Video (Optional)

Subscriber->Frontend: 54. Click "Download Video"
Frontend->HuggingFaceAPI: 55. Fetch video
HuggingFaceAPI-->Frontend: 56. MP4 file with audio
Frontend-->Subscriber: 57. Download:\ntalking_portrait_TIMESTAMP.mp4

# ==================================================================================
# COPY UNTIL HERE ↑
# ==================================================================================


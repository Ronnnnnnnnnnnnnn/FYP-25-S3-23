# FACESWAP SEQUENCE DIAGRAM FOR SEQUENCEDIAGRAM.ORG
# Copy everything below the line and paste into https://sequencediagram.org

# ==================================================================================
# COPY FROM HERE ↓
# ==================================================================================

title Face Swap - Swap Faces Between Images\nUser Story: US-U-003 - As a user, I want to use the free Face Swap feature

participant User
participant Browser
participant Frontend
participant GradioClient
participant HuggingFaceAPI
participant FaceDetector
participant FaceSwapper
participant API
participant Storage
participant Database

note over User, Database: Upload Source Face Image

User->Browser: 1. Select source image\n(face to use)
Browser->Frontend: 2. Display image preview
Frontend->Frontend: 3. Validate image\n(JPG/PNG, <20MB)

alt Invalid image
    Frontend-->User: Error: Invalid format or too large
end

note over User, Database: Upload Target Image

User->Browser: 4. Select target image\n(body/background)
Browser->Frontend: 5. Display image preview
Frontend->Frontend: 6. Validate image\n(JPG/PNG, <20MB)

alt Invalid image
    Frontend-->User: Error: Invalid format or too large
end

note over User, Database: Submit for Face Swap

User->Frontend: 7. Click "Swap Faces"
Frontend->Frontend: 8. Show progress (0%)
Frontend->GradioClient: 9. Connect to Gradio API\n(Tc12345/faceswap)

GradioClient->HuggingFaceAPI: 10. Initialize connection
HuggingFaceAPI-->GradioClient: 11. Connection established

note over Frontend, HuggingFaceAPI: Process Face Swap

Frontend->Frontend: 12. Progress: 20%\n"Uploading images..."
User->User: Update progress: 20%

GradioClient->HuggingFaceAPI: 13. Upload source and target images
HuggingFaceAPI->FaceDetector: 14. Detect faces in source image
FaceDetector-->HuggingFaceAPI: 15. Source face(s) detected

alt No face in source
    HuggingFaceAPI-->GradioClient: Error: No face in source image
    GradioClient-->Frontend: Error message
    Frontend-->User: No face detected!\nUse clear photo with visible face
end

HuggingFaceAPI->FaceDetector: 16. Detect faces in target image
FaceDetector-->HuggingFaceAPI: 17. Target face(s) detected

alt No face in target
    HuggingFaceAPI-->GradioClient: Error: No face in target image
    GradioClient-->Frontend: Error message
    Frontend-->User: No face detected in target!\nUse clear photo
end

Frontend->Frontend: 18. Progress: 60%\n"Swapping faces..."
User->User: Update progress: 60%

HuggingFaceAPI->FaceSwapper: 19. Swap faces\nsource_face -> target_face
FaceSwapper->FaceSwapper: 20. Extract source face features
FaceSwapper->FaceSwapper: 21. Match skin tone
FaceSwapper->FaceSwapper: 22. Adjust lighting
FaceSwapper->FaceSwapper: 23. Blend naturally

note over FaceSwapper: InsightFace Model\nProcessing Time: 10-30 seconds

FaceSwapper-->HuggingFaceAPI: 24. Swapped result image
HuggingFaceAPI-->GradioClient: 25. Result image URL

Frontend->Frontend: 26. Progress: 90%\n"Finalizing result..."
User->User: Update progress: 90%

GradioClient->Frontend: 27. Result image URL
Frontend->Frontend: 28. Display result image

Frontend->Frontend: 29. Progress: 100%\n"Complete!"
User->User: Update progress: 100%

note over API, User: Display Result

Frontend->User: 30. Show swapped result

note over User, Storage: Save to Dashboard (Optional)

User->Frontend: 31. Click "Save to Dashboard"
Frontend->Frontend: 32. Convert image URL to base64
Frontend->API: 33. POST /api/faceswap/save\n(image_data: base64)

API->API: 34. Decode base64 image
API->Storage: 35. Save result (PNG)\nstatic/animations/faceswap/filename.png
Storage-->API: 36. File saved

API->Database: 37. INSERT INTO animations\n(user_id, tool_type='faceswap', animation_path, status='completed')
Database-->API: 38. Animation ID

API->Frontend: 39. Response: success=true\nimage_url
Frontend->User: 40. Success message\n"Face swap saved to dashboard!"

note over User, Storage: Download Result (Optional)

User->Frontend: 41. Click "Download"
Frontend->Browser: 42. Download image\nface-swap-TIMESTAMP.png
Browser->User: 43. File downloaded

# ==================================================================================
# COPY UNTIL HERE ↑
# ==================================================================================

